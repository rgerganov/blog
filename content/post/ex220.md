+++
title = "Reversing TP-Link EX220 from A1"
date = "2025-04-04T18:16:38+03:00"
draft = true
tags = []
topics = []
description = ""
+++

Large telecoms in Bulgaria are also ISPs and there is a common practice to give out "free" Wi-Fi routers to customers.
[Last time](/post/smartcom-wpa) I wrote about the Smartcom Ralink router and its insecure default Wi-Fi passwords.
This time I will look into the [TP-Link EX220 router](https://help.a1.bg/internet/fixed-internet/wireless-routers/tp-link-ex220/initial-setup) which is being deployed by [A1](https://www.a1.bg/).

{{% fluid_img class="pure-u-1-1" src="/images/ex220.png" title="TP-Link EX220" %}}

My main motivation for this research was their ridiculous policy of forcing customers to use this router and not allowing them to use their own.
A1 also refuses to provide admin credentials for the router and people are forced to call their support for simple tasks like changing the Wi-Fi SSID.
This is both inconvenient and terrible from privacy and security perspective.

## Getting root access

[{{% fluid_img class="pure-u-1-1" src="/images/ex220-uart-small.jpg" %}}](/images/ex220-uart.jpg "Serial console")

* soldering uart header
* u-boot
* initramfs from openwrt

```
admin:I55OiXWnKr89Y:0:0:root:/:/bin/sh
dropbear:x:500:500:dropbear:/var/tmp/dropbear:/bin/sh
nobody:*:0:0:nobody:/:/bin/sh
```

**`spbu100e`**

* hashcat
* decrypting the config partition

```sh
key: 1528632946736109
 IV:  1528632946736539

openssl enc -aes-128-cbc -d -in config.bin -out config.dec --nopad -K 31353238363332393436373336313039 -iv 31353238363332393436373336353339
```

## Toolchain

TBD

## Dumping the configuration

* building a binary which dumps the config

```c
#include <stdio.h>
#include <dlfcn.h>

typedef int (*dm_shmInit_fun)(int);
typedef int (*dm_loadCfg_fun)();
typedef int (*dm_dumpCfg_fun)();

int main(int argc, char * argv[])
{
    void *handle = dlopen("/lib/libcmm.so", RTLD_LAZY);
    if (!handle) {
        fprintf(stderr, "dlopen failed\n");
        return 1;
    }
    dm_shmInit_fun dm_shmInit = dlsym(handle, "dm_shmInit");
    dm_loadCfg_fun dm_loadCfg = dlsym(handle, "dm_loadCfg");
    dm_dumpCfg_fun dm_dumpCfg = dlsym(handle, "dm_dumpCfg");
    if (!dm_shmInit || !dm_loadCfg || !dm_dumpCfg) {
        fprintf(stderr, "dlsym failed\n");
        return 1;
    }
    dm_shmInit(0);
    dm_loadCfg();
    dm_dumpCfg();
    return 0;
}
```

```sh
$OPENADK_ROOT/toolchain_generic-mips_uclibc-ng_mips32r2el_soft/usr/mipsel-openadk-linux-uclibc/bin/gcc -o dumpcfg dumpcfg.c -ldl
python3 -m http.server
```

```bash
curl --output dumpcfg http://192.168.0.2:8000/dumpcfg
chmod +x dumpcfg
export LD_PRELOAD=/lib/libgdpr.so:/lib/libcutil.so:/lib/libmapShared.so:/lib/libos.so:/lib/libxml.so:/lib/libcmm.so
./dumpcfg
```

Result:

```xml
<Device>
...
  <DeviceInfo>
    <ManufacturerOUI>F0A731</ManufacturerOUI>
    <X_TP_DeviceModel>EX220(EU)</X_TP_DeviceModel>
    <SerialNumber>REDACTED</SerialNumber>
    <HardwareVersion>EX220 v1.0 00000000</HardwareVersion>
    <SoftwareVersion>A1.EX220.016</SoftwareVersion>
    <ProvisioningCode>1</ProvisioningCode>
    <UpTime>7</UpTime>
    <X_TP_ConfigVersion>1509949442</X_TP_ConfigVersion>
  </DeviceInfo>
  ...
  <X_TP_UserCfg>
    <AdminName>root</AdminName>
    <AdminPwd>aDm1n$TR8r</AdminPwd>
    <UserEnable>0</UserEnable>
    <UserRemoteEnable>0</UserRemoteEnable>
  </X_TP_UserCfg>
  ...
</Device>
```

## SSH access

* build dropbear
* mod and flash rootfs

## WPS PIN generation

{{% fluid_img class="pure-u-1-1" src="/images/ex220-wps.png" title="WPS PIN" %}}

TODO

{{% fluid_img class="pure-u-1-1" src="/images/ex220-wps-gen.png" title="WPS PIN Generation" %}}


```
2025-04-06 12:40:40  ->  1743932440  ->  69636486

$ ./rand 1743932440
rand() = 669636489

```